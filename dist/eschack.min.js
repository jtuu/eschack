/*! eschack 2016-04-27 */

"use strict";function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},_createClass=function(){function a(a,b){for(var c=0;b.length>c;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();Object.values||(Object.values=function(a){return Object.keys(a).map(function(b){return a[b]})}),function(global){var env="prod",TICK=1,saveName="eschack_save",mainCanvas=document.getElementById("canvas-main"),secondCanvas=document.getElementById("canvas-second"),w=1040,h=520;mainCanvas.width=w,mainCanvas.height=h,secondCanvas.width=w,secondCanvas.height=h;var mainCtx=mainCanvas.getContext("2d"),secondCtx=secondCanvas.getContext("2d");mainCtx.font="20px Consolas",mainCtx.textAlign="center";var objectCounter=0,Point=function(){function a(b,c){_classCallCheck(this,a),this.x=b,this.y=c}return a.prototype.set=function(a){this.x=a[0],this.y=a[1]},a.prototype.moveBy=function(a){var b=a.get,c=b[0],d=b[1];this.x+=c,this.y+=d},a.distance=function(a,b){return new Vector(b.x-a.x,b.y-a.y)},a.equal=function(a,b){return a.x===b.x&&a.y===b.y},a.prototype.in=function(a){return this.x>=a.x&&a.x+a.w>=this.x&&this.y>=a.y&&a.y+a.h>=this.y},_createClass(a,[{key:"get",get:function(){return[this.x,this.y]}}]),a}(),Vector=function(){function a(b,c){_classCallCheck(this,a),this.u=isNaN(b)?Math.sign(10*Math.random()-5):b,this.v=isNaN(c)?Math.sign(10*Math.random()-5):c}return a.prototype.set=function(a){this.u=a[0],this.v=a[1]},a.prototype.reduce=function(){var a=this.get,b=Math.max.apply(null,a.map(Math.abs));this.set(a.map(function(a){return Math.round(a/b)}))},_createClass(a,[{key:"get",get:function(){return[this.u,this.v]}}]),a}(),Tile=function(){function a(b){_classCallCheck(this,a),this.position=b,this.contents=[]}return a.prototype.add=function(a){if(!a instanceof GameObject)throw new TypeError("Added object must be of type GameObject.");a.isMoveBlocking?this.contents.unshift(a):this.contents.push(a)},a.prototype.remove=function(a){var b=this.contents.indexOf(a);return b>-1?(this.contents.splice(b,1),!0):!1},a.prototype.empty=function(){this.contents=[]},a.prototype.toString=function(){return"Floor"},_createClass(a,[{key:"isEmpty",get:function(){return 0===this.contents.length}},{key:"top",get:function(){return this.contents[0]}},{key:"get",get:function(){return this.contents}}]),a}(),TileGroup=function(){function a(b,c){var d=this;_classCallCheck(this,a);for(var e in c)this[e]=c[e];if(b)this.matrix=b,this.w=this.matrix[0].length,this.h=this.matrix.length;else{this.matrix=[];for(var f=0;this.h>f;f++){this.matrix[f]=[];for(var g=0;this.w>g;g++)this.matrix[f][g]=new Tile(new Point(g,f))}}if(this.matrix.forEach(this.origin.x>=0?function(a,b){return d.matrix[b]=Array(d.origin.x).concat(d.matrix[b])}:function(a,b){for(var c=0;-d.origin.x>c;c++)d.matrix[b].shift()}),this.origin.y>=0)this.matrix=Array(this.origin.y).concat(this.matrix);else for(var h=0;-this.origin.y>h;h++)this.matrix.shift();this.baseColor=this.baseColor||"slategrey",this.tileSize=this.tileSize||25,this.spacing=this.spacing||1}return a.prototype.update=function(){var a=this;this.matrix.forEach(function(b){return b.forEach(function(b){if(b&&!b.isEmpty){var c=b.top;b.contents.shift(),a.insert(c)}})})},a.prototype.insert=function(a){var b=a.position.get,c=b[0],d=b[1];this.has(a.position)&&this.matrix[d][c].add(a)},a.prototype.remove=function(a){var b=a.position.get,c=b[0],d=b[1];this.has(a.position)&&this.matrix[d][c].remove(a)},a.prototype.clear=function(){this.matrix.forEach(function(a){return a.forEach(function(a){return a.empty()})})},a.prototype.has=function(a){var b=a.get,c=b[0],d=b[1];return!!this.matrix[d]&&!!this.matrix[d][c]},a.prototype.get=function(a){var b=a.get,c=b[0],d=b[1];return this.has(a)?this.matrix[d][c]:void 0},a.prototype.draw=function(){var a=this;this.matrix.forEach(function(b){return b.forEach(function(b){if(b){var c=b.position.get,d=c[0],e=c[1];b.isEmpty?(mainCtx.fillStyle=a.baseColor,mainCtx.fillRect(d*(a.tileSize+a.spacing),e*(a.tileSize+a.spacing),a.tileSize,a.tileSize)):(mainCtx.fillStyle=b.top.bgColor,mainCtx.fillRect(d*(a.tileSize+a.spacing),e*(a.tileSize+a.spacing),a.tileSize,a.tileSize),mainCtx.fillStyle=b.top.color,mainCtx.fillText(b.top.glyph,d*(a.tileSize+a.spacing)+a.tileSize/2,e*(a.tileSize+a.spacing)+a.tileSize/1.5))}})})},_createClass(a,[{key:"bounds",get:function(){return{x:this.origin.x*(this.tileSize+this.spacing),y:this.origin.y*(this.tileSize+this.spacing),w:this.w*(this.tileSize+this.spacing)-this.spacing,h:this.h*(this.tileSize+this.spacing)-this.spacing}}}]),a}(),GameObject=function(){function GameObject(a){if(_classCallCheck(this,GameObject),this.constructor===GameObject)throw new TypeError("GameObject is abstract");this.id=objectCounter,objectCounter+=1,this.position=a,this.bgColor="magenta",this.glyph="⚠",this.color="black",this.flavorName="OBJ",this.type=this.constructor.name}return GameObject.prototype.update=function(){},GameObject.from=function from(obj){var point=null;obj.position&&(point=new Point(obj.position.x,obj.position.y));var newObj=new this(point,obj.stats),exempt=["lifebar","position","inventory","equipment"];for(var key in obj)exempt.includes(key)||(newObj[key]=obj[key]);newObj.inventory=[];for(var _key in obj.inventory)newObj.inventory[_key]=eval(obj.inventory[_key].type).from(obj.inventory[_key]);newObj.equipment=[];for(var _key2 in obj.equipment)newObj.equipment[_key2]=eval(obj.equipment[_key2].type).from(obj.equipment[_key2]);return newObj},GameObject.prototype.toString=function(){return this.type},_createClass(GameObject,[{key:"isAlive",get:function(){return this.hasOwnProperty("stats")?this.stats.HP>0:!0}}]),GameObject}(),MoveBlocking=function(a){return function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.apply(this,arguments))}return _inherits(b,a),_createClass(b,[{key:"isMoveBlocking",get:function(){return!0}}]),b}(a)},VisionBlocking=function(a){return function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.apply(this,arguments))}return _inherits(b,a),_createClass(b,[{key:"isVisionBlocking",get:function(){return!0}}]),b}(a)},Hittable=function(a){return function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.apply(this,arguments))}return _inherits(b,a),b.prototype.takeDamage=function(a,b){return this.stats.HP-=a,this.lifebar&&this.lifebar.set(this.stats.HP),0>=this.stats.HP?(this.die(b),!0):!1},b.prototype.die=function(a){a&&a.log(this.flavorName+" died","death"),this.lifebar&&this.lifebar.remove()},_createClass(b,[{key:"isHittable",get:function(){return!0}}]),b}(a)},Wall=function(a){function Wall(b){_classCallCheck(this,Wall);var c=_possibleConstructorReturn(this,a.call(this,b));return c.bgColor="hsl(0,0%,15%)",c.glyph="▉",c.color="hsl(0,0%,25%)",c.flavorName="wall",c}return _inherits(Wall,a),Wall.prototype.update=function(){return 0},Wall}(VisionBlocking(MoveBlocking(GameObject))),Creature=function(a){function Creature(b,c,d){_classCallCheck(this,Creature);var e=_possibleConstructorReturn(this,a.call(this,b));return e.actions=[],e.stats=c||{maxHP:3,HP:3,viewDistance:5,moveSpeed:10,inventorySize:5},e.weapon=d||new Weapon("Claws"),e.inventory=[e.weapon],e.flavorName="creature",e.flavor="It is mundane.",e}return _inherits(Creature,a),Creature.prototype.update=function(){var a=this,b=1>=arguments.length||void 0===arguments[1]?0:arguments[1],c=0,d=0;this.actions.forEach(function(e){try{var f=void 0;e.some(function(c){var d=c();return d.try(a,b)?(f=d,!0):!1}),d+=f.do(a),c++}catch(g){}});for(var e=0;c>e;e++)this.actions.shift();return d},Creature.prototype.toString=function(){return this.type+"<br>"+this.stats.HP+" HP<br>"+this.flavor+"<br>"+this.weapon.damage+" ATT"},Creature}(Hittable(MoveBlocking(GameObject))),Player=function(a){function Player(b,c){_classCallCheck(this,Player);var d=_possibleConstructorReturn(this,a.call(this,b,c,new Weapon("Dagger",1,5)));return d.actions=[],d.bgColor="white",d.glyph="@",d.color="black",d.stats.maxHP=50,d.stats.HP=50,d.stats.viewDistance=8,d.stats.moveSpeed=10,d.stats=c||d.stats,d.lifebar=new Lifebar(d.id,"Hero",document.getElementById("info-container-player"),d.stats.maxHP,d.stats.HP),d.flavorName="you",d.flavor="Hi mom!",d}return _inherits(Player,a),Player}(Creature),Enemy=function(a){function Enemy(b,c){_classCallCheck(this,Enemy);var d=_possibleConstructorReturn(this,a.call(this,b,c,new Weapon("Claws",2,10)));return d.actions=[],d.bgColor="hsl(30, 30%, 45%)",d.glyph="E",d.color="white",d.stats.maxHP=3,d.stats.HP=3,d.stats.viewDistance=7,d.stats.moveSpeed=9,d.stats=c||d.stats,d.lifebar=new Lifebar(d.id,"Enemy",document.getElementById("info-container-other-life"),d.stats.maxHP,d.stats.HP),d.flavorName="the enemy",d.flavor="It has a fearsome visage.",d}return _inherits(Enemy,a),Enemy.prototype.toString=function(){return this.type+"<br>"+this.stats.HP+" HP<br>"+this.flavor+"<br>"+this.weapon.damage+" ATT<br>"+(this.noticed?"It has noticed you.":"It has not noticed you.")},Enemy}(Creature),Item=function(a){function Item(b){return _classCallCheck(this,Item),_possibleConstructorReturn(this,a.call(this,b))}return _inherits(Item,a),Item.prototype.update=function(){return!0},Item}(GameObject),Weapon=function(a){function Weapon(b,c,d){_classCallCheck(this,Weapon);var e=_possibleConstructorReturn(this,a.call(this,null));return e.damage=c||1,e.speed=d||10,e.name=b,e}return _inherits(Weapon,a),Weapon.prototype.toString=function(){return this.name+" ("+this.damage+", "+this.speed+")"},Weapon}(Item),Action=function(){function a(b,c){if(_classCallCheck(this,a),this.constructor===GameObject)throw new TypeError("Action is abstract");this.context=b,this.logger=c}return a.prototype.try=function(){},a.prototype.do=function(){},a}(),NullAction=function(a){function b(c,d){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.call(this,c,d))}return _inherits(b,a),b.prototype.try=function(a,b){return b%10===0},b.prototype.do=function(){return 10},b}(Action),MoveAction=function(a){function b(c,d,e){_classCallCheck(this,b);var f=_possibleConstructorReturn(this,a.call(this,c,d));return f.movement=e,f}return _inherits(b,a),b.prototype.try=function(a,b){if(this.duration=a.stats.moveSpeed,b%this.duration!==0)return!1;var c=new(Function.prototype.bind.apply(Point,[null].concat(a.position.get)));c.moveBy(this.movement);var d=this.context.get(c);return d.isEmpty||d&&d.top&&!d.top.isMoveBlocking},b.prototype.do=function(a){return a.position.moveBy(this.movement),this.context.update(),this.duration},b}(Action),AttackAction=function(a){function b(c,d,e){_classCallCheck(this,b);var f=_possibleConstructorReturn(this,a.call(this,c,d));return f.direction=e,f}return _inherits(b,a),b.prototype.try=function(a,b){if(this.duration=a.weapon.speed,b%this.duration!==0)return!1;var c=new(Function.prototype.bind.apply(Point,[null].concat(a.position.get)));c.moveBy(this.direction);var d=this.context.get(c);return d&&d.top&&d.top.isHittable},b.prototype.do=function(a){var b=new(Function.prototype.bind.apply(Point,[null].concat(a.position.get)));b.moveBy(this.direction),b=this.context.get(b),this.logger&&this.logger.log(a.flavorName+" hit "+b.top.flavorName+" for "+a.weapon.damage+" damage with "+a.weapon,a.constructor===Player?"hit":"damage");var c=b.top.takeDamage(a.weapon.damage,this.logger);return c&&this.context.remove(b.top),this.context.update(),this.duration},b}(Action),ItemPickupAction=function(a){function b(c,d){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.call(this,c,d))}return _inherits(b,a),b.prototype.try=function(a,b){return b%10===0&&a.stats.inventorySize>a.inventory.length&&this.context.get(a.position).contents.some(function(a){return a instanceof Item})},b.prototype.do=function(a){var b=this.context.get(a.position),c=b.contents.find(function(a){return a instanceof Item});return a.inventory.push(c),b.remove(c),this.logger&&this.logger.log(a.flavorName+" picked up "+c.flavorName),10},b}(Action),ItemDropAction=function(a){function b(c,d,e){_classCallCheck(this,b);var f=_possibleConstructorReturn(this,a.call(this,c,d));return f.inventorySlot=e,f}return _inherits(b,a),b.prototype.try=function(a,b){var c=!!a.inventory[Utils.alphabetMap.indexOf(this.inventorySlot)];return c||this.logger.log("No such item"),b%10===0&&c},b.prototype.do=function(a){var b=Utils.alphabetMap.indexOf(this.inventorySlot),c=a.inventory[b];return a.inventory.splice(b,1),c.position=new(Function.prototype.bind.apply(Point,[null].concat(a.position.get))),this.context.insert(c),10},b}(Action),Lifebar=function(){function a(b,c,d,e,f){_classCallCheck(this,a),this.id=b,this.name=c,this.max=e,this.value=f||e,this.container=d;var g=document.createElement("label");g.setAttribute("for","bar-lifebar-"+this.name+"-"+this.id),g.innerHTML=this.name,this.label=g;var h=document.createElement("div");h.className="bar bar-lifebar",h.id="bar-lifebar-"+this.name+"-"+this.id,this.bar=h,this.set(),this.container.appendChild(g),this.label.appendChild(h)}return a.prototype.set=function(a){isNaN(a)||(this.value=a),this.bar.setAttribute("data-content",this.value+"/"+this.max);var b="bar-size-"+Math.max(Math.floor(this.value/this.max*100),0);this.bar.className.match(/size/)?this.bar.className=this.bar.className.replace(/bar-size-[0-9]{1,3}/,b):this.bar.classList.add(b)},a.prototype.setStyle=function(a){var b=this,c={hilight:"hilighted","default":"default"};a=c[a],a&&(Object.values(c).filter(function(b){return b!==a}).forEach(function(a){b.bar.classList.remove(a),b.label.classList.remove(a)}),this.bar.classList.add(a),this.label.classList.add(a))},a.prototype.remove=function(){this.bar.remove(),this.label.remove()},a.prototype.hide=function(){this.bar.style.display="none",this.label.style.display="none"},a.prototype.show=function(){this.bar.style.display="",this.label.style.display=""},a}(),KeyHandler=function(){function a(){_classCallCheck(this,a),this.use("default")}return a.prototype.use=function(){var a=0>=arguments.length||void 0===arguments[0]?"default":arguments[0];"default"===a?(this.using="default",this.keyCases={104:"n",100:"w",98:"s",102:"e",105:"ne",99:"se",97:"sw",103:"nw",101:"c",g:"pickup",71:"pickup",68:"dropdialog"},this.actionMap={n:function(){return new Vector(0,-1)},w:function(){return new Vector(-1,0)},s:function(){return new Vector(0,1)},e:function(){return new Vector(1,0)},ne:function(){return new Vector(1,-1)},se:function(){return new Vector(1,1)},sw:function(){return new Vector(-1,1)},nw:function(){return new Vector(-1,-1)},c:null,pickup:"pickup",dropdialog:function(){return"drop"}}):"dropdialog"===a&&(this.using="dropdialog",this.keyCases="abcdefghijklmnopqrstuvwxyz".split("").reduce(function(a,b){return a[b.toUpperCase().charCodeAt(0)]=b,a},{}))},a.prototype.get=function(a){if("dropdialog"===this.keyCases[a])return this.use("dropdialog"),"drop";if("dropdialog"===this.using){var b=this.keyCases[a];return this.use(),"drop:"+b}return this.actionMap[this.keyCases[a]]},a}(),ActionManager=function(){function a(b,c){_classCallCheck(this,a),this.board=b,this.logger=c,this.proposalMap={},this.proposalMap[Vector]=[MoveAction,AttackAction,NullAction],this.proposalMap.pickup=[ItemPickupAction,NullAction],this.proposalMap.drop=[ItemDropAction,NullAction]}return a.prototype.think=function(a,b){var c=this;if(a instanceof Enemy){var d=function(){var d=c.getFov(a),e=null,f=c.getFov(b).has(a.position);if(a.target=d.get(b.position)){if(Point.equal(a.position,a.target.position))return a.target=void 0,{v:void 0};var g=Point.distance(a.position,a.target.position);g.reduce(),e=g,!a.noticed&&f&&c.logger.log(a.flavorName+" noticed "+b.flavorName),a.noticed=!0}else e=new Vector,a.noticed=!1;var h=c.proposalMap[e.constructor];if(h){var i=h.map(function(a){return function(){return new a(c.board,f?c.logger:null,e)}});a.actions.push(i)}}();if("object"===(void 0===d?"undefined":_typeof(d)))return d.v}},a.prototype.getFov=function(a){if(a){for(var b=a.position.get,c=b[0],d=b[1],e=a.stats.viewDistance,f={ne:[],se:[],sw:[],nw:[]},g=0;e>g;g++)for(var h=0;e>h;h++)f.ne[g]||(f.ne[g]=[],f.se[g]=[],f.sw[g]=[],f.nw[g]=[]),f.ne[g][h]=this.board.get(new Point(c+h,d-e+g+1)),f.se[g][h]=this.board.get(new Point(c+h,d+g)),f.sw[g][h]=this.board.get(new Point(c-e+h+1,d+g)),f.nw[g][h]=this.board.get(new Point(c-e+h+1,d-e+g+1));return f.ne=Utils.rotate(Utils.beamcast(Utils.rotate(f.ne,90)),-90),f.se=Utils.beamcast(f.se),f.sw=Utils.rotate(Utils.beamcast(Utils.rotate(f.sw,-90)),90),f.nw=Utils.rotate(Utils.beamcast(Utils.rotate(f.nw,180)),-180),new TileGroup(Utils.mergeQuarters(f),{origin:new Point(c-e+1,d-e+1),baseColor:"hsla(244,3%,55%,1)",tileSize:25,spacing:1})}},a.prototype.delegateAction=function(a,b){var c=this;if(a){if(b){var d=b;if("function"==typeof b)b=b(),d=b.constructor;else if("string"==typeof b){var e=b.split(":");if(d=e[0],b=e[1],"drop"===d&&!b)return this.logger.log("Which item to drop? [a-z]"),!1}var f=this.proposalMap[d];if(f){var g=f.map(function(a){return function(){return new a(c.board,c.logger,b)}});return a.actions.push(g),!0}}else if(null===b)return a.actions.push([function(){return new NullAction(null,c.logger)}]),!0;return!1}},a}(),Utils=function(){function a(){_classCallCheck(this,a)}return a.rotate=function(b,c){return 90===c?a.transpose(b.reverse()):-90===c?a.transpose(b).reverse():180===c||-180===c?a.transpose(a.transpose(b).reverse()).reverse():b},a.transpose=function(a){var b=a.length?a.length:0,c=a[0]instanceof Array?a[0].length:0;if(0===c||0===b)return[];var d,e,f=[];for(d=0;c>d;d++)for(f[d]=[],e=0;b>e;e++)f[d][e]=a[e][d];return f},a.beamcast=function(a){for(var b=[],c=0;a.length>c;c++)b[c]=Array.from(Array(a.length));b[0][0]=a[0][0];for(var d=0;a[d]&&a[d][0]&&(b[d][0]=a[d][0],!a[d][0].top||!a[d][0].top.isVisionBlocking);)d++;for(var e=0;a[0]&&a[0][e]&&(b[0][e]=a[0][e],!a[0][e].top||!a[0][e].top.isVisionBlocking);)e++;for(var f=1,g=31;g>=f;f++)for(var h=f,i=0,j=g,k=0;j>=i;k++){var l=h>>5,m=k-l,n=g+1-(h&g),o=!1;if(n>i&&(a[m]&&a[m][l]?(b[m][l]=a[m][l],a[m][l].top&&a[m][l].top.isVisionBlocking&&(i=n,o=!0)):(i=n,o=!0)),n>j&&(a[m]&&a[m][l]?(b[m][l]=a[m][l],a[m][l].top&&a[m][l].top.isVisionBlocking&&(j=n,o=!0)):(j=n,o=!0)),h+=f,o)break}return b},a.mergeQuarters=function(a){var b=a.nw.map(function(b,c){return b.pop(),b.concat(a.ne[c])}),c=a.sw.map(function(b,c){return b.pop(),b.concat(a.se[c])});return b.pop(),b.concat(c)},a.saveGame=function(a){var b={};b.objs=a.objs,b.objs.forEach(function(a){return delete a.fov}),localStorage.setItem(saveName,LZString.compress(JSON.stringify(b)))},a.loadGame=function(){var a=JSON.parse(LZString.decompress(localStorage.getItem(saveName))||null);if(!a)return null;var b=function(){var b={Wall:Wall,Creature:Creature,Enemy:Enemy,Player:Player,Item:Item,Weapon:Weapon},c=[];return a.objs.forEach(function(a){a&&b[a.type]&&(c[a.id]=b[a.type].from(a))}),{v:c}}();return"object"===(void 0===b?"undefined":_typeof(b))?b.v:void 0},a.deleteSave=function(){localStorage.removeItem(saveName)},a.screenToGame=function(a,b,c){return new Point(Math.floor(a.x/(b+c)),Math.floor(a.y/(b+c)))},a.gameToScreen=function(a,b,c){return new Point(a.x*(b+c),a.y*(b+c))},a.screenToTiles=function(b,c,d){return a.gameToScreen(a.screenToGame(b,c,d),c,d)},a.exportObjs=function(a){for(var b in a)global[b]=a[b]},a.initUIButtons=function(a){var b=this;document.getElementById("button-save").addEventListener("click",function(c){c.stopPropagation(),b.saveGame(a)}),document.getElementById("button-delete").addEventListener("click",function(a){a.stopPropagation(),b.deleteSave()})},_createClass(a,null,[{key:"exports",get:function(){return{instance:game,Creature:Creature,Player:Player,GameObject:GameObject,Point:Point,Vector:Vector,ActionManager:ActionManager,TileGroup:TileGroup,Utils:a,Tile:Tile,Wall:Wall}}},{key:"alphabetMap",get:function(){return["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"]}},{key:"DungeonGenerator",get:function(){return function(){function a(){_classCallCheck(this,a)}return a.makeRoom=function(a){var b={};return b.w=~~(Math.random()*(a.rooms.size.max.w-a.rooms.size.min.w)+a.rooms.size.min.w),b.h=~~(Math.random()*(a.rooms.size.max.h-a.rooms.size.min.h)+a.rooms.size.min.h),b.x=~~(Math.random()*(a.size.w-b.w)),b.y=~~(Math.random()*(a.size.h-b.h)),b},a.makePoint=function(a){return{x:~~(Math.random()*a.size.w),y:~~(Math.random()*a.size.h)}},a.makePaths=function(a,b,c){for(var d=[],e=0;c.paths.count>e;e++){var f={},g=b[e%c.paths.count%c.midPoints.count];f.x1=a[e].x+~~(Math.random()*a[e].w),f.y1=a[e].y+~~(Math.random()*a[e].h),f.x2=g.x,f.y2=a[e].y+~~(Math.random()*a[e].h),f.x3=g.x,f.y3=g.y,d.push(f)}for(var h=1;c.midPoints.count>h;h++){var i={};i.x1=b[h-1].x,i.y1=b[h-1].y,i.x2=b[h].x,i.y2=b[h-1].y,i.x3=b[h].x,i.y3=b[h].y,d.push(i)}return d},a.insertEnemies=function(a,b){for(var c=[],d=a.x+a.w;d>a.x;d--)for(var e=a.y+a.h;e>a.y;e--)Math.random()<b.enemies.spawnChance&&c.push(new Enemy(new Point(d,e)));return c},a.makeDungeon=function(a){var b=this;a=a||this.defaultOptions;var c=[],d=[],e=Array(a.rooms.count).fill(),f=Array(a.midPoints.count).fill();for(var g in e)e[g]=this.makeRoom(a);d.push(new Player(new Point(e[0].x+1,e[0].y+1)));for(var h in f)f[h]=this.makePoint(a);for(var i=this.makePaths(e,f,a),j=0;a.size.h>j;j++){c[j]=[];for(var k=0;a.size.w>k;k++){var l=new Tile(new Point(k,j));l.add(new Wall(new Point(k,j))),c[j][k]=l}}e.forEach(function(e){for(var f=e.x+e.w;f>e.x;f--)for(var g=e.y+e.h;g>e.y;g--)c[g][f].empty();d=d.concat(b.insertEnemies(e,a))}),i.forEach(function(a){for(var b=Math.min(a.x1,a.x2),d=Math.max(a.x1,a.x2);d>b;b++)c[a.y1][b].empty();for(var e=Math.min(a.y2,a.y3),f=Math.max(a.y2,a.y3);f>e;e++)c[e][a.x2].empty()});for(var m=0;a.size.h>m;m++)for(var n=0;a.size.w>n;n++)c[m][n].isEmpty||d.push(c[m][n].top);return d},_createClass(a,null,[{key:"defaultOptions",get:function(){return{size:{w:40,h:20},rooms:{count:8,size:{max:{w:8,h:8},min:{w:3,h:3}}},midPoints:{count:2},paths:{count:8},enemies:{spawnChance:.02}}}}]),a}()}}]),a}(),LogboxManager=function(){function a(b,c){_classCallCheck(this,a),this.logbox=b,this.rowCount=c,this.rows=[],this.messages=[];for(var d=0;this.rowCount>d;d++){var e=document.createElement("div");e.className="logbox-row",e.id="logbox-row-"+(d+1),this.logbox.appendChild(e),this.rows.push(e)}}return a.prototype.log=function(a){var b=this,c=1>=arguments.length||void 0===arguments[1]?"default":arguments[1];a=a.charAt(0).toUpperCase()+a.slice(1);var d=document.createElement("span");d.className="logmsg logmsg-"+c,d.innerHTML=a,this.messages.push(d);var e=this.rows.find(function(a){return 0===a.children.length});e?e.appendChild(d):(this.rows[0].children[0].remove(),this.rows.forEach(function(a,c){a.appendChild(b.messages[b.messages.length-(b.rowCount-c)])}))},a}(),InventoryManager=function(){function a(b,c){_classCallCheck(this,a),this.wrapper=b,this.inventory=c;var d=document.createElement("div");d.style.padding="10px",this.container=d,this.wrapper.appendChild(this.container)}return a.prototype.update=function(){var a=this;this.container.children.length&&Array.from(this.container.children).forEach(function(a){return a.remove()}),this.inventory.forEach(function(b,c){var d=document.createElement("div");d.innerHTML=Utils.alphabetMap[c]+" - "+b,a.container.appendChild(d)})},a}(),MouseHandler=function(){function a(b){_classCallCheck(this,a),this.board=b;var c=document.createElement("div");c.id="cursor",c.style.width=this.board.tileSize+"px",c.style.height=this.board.tileSize+"px",this.cursor=c,document.body.appendChild(this.cursor)}return a.prototype.cursorFromScreen=function(a){var b=Utils.screenToTiles(a,this.board.tileSize,this.board.spacing).get,c=b[0],d=b[1];this.cursor.style.top=d+"px",this.cursor.style.left=c+"px"},a.prototype.cursorFromGame=function(a){var b=Utils.gameToScreen(a,this.board.tileSize,this.board.spacing).get,c=b[0],d=b[1];this.cursor.style.top=d+"px",this.cursor.style.left=c+"px"},a}(),Game=function(){function a(b,c){var d=this;_classCallCheck(this,a),this.logger=new LogboxManager(document.getElementById("logbox"),10),this.time=0,this.board=b,this.player=c.find(function(a){return a}),this.objs=[],c.forEach(function(a){return d.objs[a.id]=a}),this.logic=new ActionManager(this.board,this.logger),this.keyHandler=new KeyHandler,document.addEventListener("keydown",function(a){d.logic.delegateAction(d.player,d.keyHandler.get(a.keyCode))&&d.update()});var e=document.getElementById("info-container-other-misc");this.examineContainer=document.createElement("div"),this.examineContainer.style.padding="10px",e.appendChild(this.examineContainer),this.mouseHandler=new MouseHandler(this.board),document.addEventListener("mousemove",function(a){var b=d.board.bounds,c=new Point(a.pageX,a.pageY);if(c.in(b)){var e=d.player.fov,f=Utils.screenToGame(c,d.board.tileSize,d.board.spacing);if(d.mouseHandler.cursorFromScreen(c),e&&e.has(f)){var g=d.board.get(f);g&&g.top?(d.objs.forEach(function(a){a.lifebar&&a.lifebar.setStyle("default")}),d.examineContainer.innerHTML=g.top,g.top instanceof Creature&&g.top.lifebar.setStyle("hilight")):d.examineContainer.innerHTML=g}else d.examineContainer.innerHTML="You can't see that"}else if(a.target.classList.contains("bar-lifebar")){d.objs.forEach(function(a){a.lifebar&&a.lifebar.setStyle("default")});var h=a.target.id.match(/[0-9]+$/),i=d.objs[+h];i&&(d.mouseHandler.cursorFromGame(i.position),d.examineContainer.innerHTML=i,i.lifebar.setStyle("hilight"))}}),this.inventoryManager=new InventoryManager(document.getElementById("info-container-inventory"),this.player.inventory)}return a.prototype.update=function(){for(var a=this,b=this.player.update(this.logger),c=b/TICK,d=[],e=0;c>e;e++)this.time+=TICK,this.objs.forEach(function(b,c){if(0!==c)if(b.isAlive){var e=b.update(a.logger,a.time+(d[b.id]||0));e>0&&(a.logic.think(b,a.player),d[b.id]=d[b.id]?d[b.id]+e:e),b.isAlive||(a.board.remove(b),delete a.objs[b.id])}else a.board.remove(b),delete a.objs[b.id]});this.player.isAlive||(this.board.remove(this.player),delete this.player);var f=this.logic.getFov(this.player);this.player.fov=f,f&&(this.objs.forEach(function(a){"Enemy"===a.type&&(f.has(a.position)?a.lifebar.show():a.lifebar.hide())}),mainCtx.clearRect(0,0,w,h),f.draw(),secondCtx.drawImage(mainCanvas,0,0)),this.inventoryManager.update()},a.prototype.start=function(){var a=this;this.logger.log("Hello and welcome","hilight"),this.objs.forEach(function(b){b&&a.board.insert(b)});var b=this.logic.getFov(this.player);this.player.fov=b,this.objs.forEach(function(c){a.logic.think(c,a.player),"Enemy"===c.type&&(b.has(c.position)?c.lifebar.show():c.lifebar.hide())}),b.draw(),this.inventoryManager.update(),document.getElementById("loader").remove()},a}(),game=new Game(new TileGroup(null,{origin:new Point(0,0),baseColor:"slategrey",tileSize:25,spacing:1,w:40,h:20}),Utils.loadGame()||Utils.DungeonGenerator.makeDungeon());if(Utils.initUIButtons(game),"dev"===env)Utils.exportObjs(Utils.exports);else if("prod"!==env)throw new TypeError("Invalid environment");game.start()}(window);
//# sourceMappingURL=eschack.min.js.map