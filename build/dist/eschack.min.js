/*! eschack 2016-05-10 */

"use strict";function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},_createClass=function(){function a(a,b){for(var c=0;b.length>c;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();!function(global){var Action=function(){function a(b,c){if(_classCallCheck(this,a),this.constructor===a)throw new TypeError("Action is abstract");this.context=b,this.logger=c}return a.prototype.try=function(){},a.prototype.do=function(){},a}();Object.values||(Object.values=function(a){return Object.keys(a).map(function(b){return a[b]})});var env="prod",TICK=1,saveName="eschack_save",mainCanvas=document.getElementById("canvas-main"),secondCanvas=document.getElementById("canvas-second"),w=1040,h=520,TILE_COLOR="hsla(244,3%,55%,1)",BASE_XP=1.3,BASE_XP_GROWTH=1.4;mainCanvas.width=secondCanvas.width=w,mainCanvas.height=secondCanvas.height=h;var mainCtx=mainCanvas.getContext("2d"),secondCtx=secondCanvas.getContext("2d");mainCtx.font="20px Consolas",mainCtx.textAlign="center";var objectCounter=0,Point=function(){function a(b,c){_classCallCheck(this,a),this.x=b,this.y=c}return a.prototype.set=function(a,b){a.constructor===Array?(this.x=a[0],this.y=a[1]):(this.x=a,this.y=b)},a.prototype.moveBy=function(a){var b=a.get,c=b[0],d=b[1];this.x+=c,this.y+=d},a.distance=function(a,b){return new Vector(b.x-a.x,b.y-a.y)},a.equal=function(a,b){return a.x===b.x&&a.y===b.y},a.prototype.in=function(a){return this.x>=a.x&&a.x+a.w>=this.x&&this.y>=a.y&&a.y+a.h>=this.y},_createClass(a,[{key:"get",get:function(){return[this.x,this.y]}}]),a}(),GameObject=function(){function GameObject(a){if(_classCallCheck(this,GameObject),this.constructor===GameObject)throw new TypeError("GameObject is abstract");this.id=objectCounter,objectCounter+=1,this.position=a,this.bgColor="magenta",this.glyph="âš ",this.color="black",this.flavorName="OBJ",this.type=this.constructor.name}return GameObject.prototype.update=function(){},GameObject.from=function from(obj){var point=null;obj.position&&(point=new Point(obj.position.x,obj.position.y));var newObj=new this(point,obj.stats),exempt=["lifebar","position","inventory","equipment"];for(var key in obj)exempt.includes(key)||(newObj[key]=obj[key]);newObj.inventory=[];for(var _key in obj.inventory)newObj.inventory[_key]=eval(obj.inventory[_key].type).from(obj.inventory[_key]);newObj.equipment=[];for(var _key2 in obj.equipment)newObj.equipment[_key2]=eval(obj.equipment[_key2].type).from(obj.equipment[_key2]);return newObj},GameObject.prototype.toString=function(){return this.type},_createClass(GameObject,[{key:"isAlive",get:function(){return this.hasOwnProperty("stats")?this.stats.HP>0:!0}}]),GameObject}(),Lifebar=function(){function a(b,c,d,e){_classCallCheck(this,a),this.id=b,this.name=c,this.stats=e,this.container=d;var f=document.createElement("label");f.setAttribute("for","bar-lifebar-"+this.name+"-"+this.id),f.innerHTML=this.name,this.label=f;var g=document.createElement("div");g.className="bar bar-lifebar",g.id="bar-lifebar-"+this.name+"-"+this.id,this.bar=g,this.set(),this.container.appendChild(f),this.label.appendChild(g)}return a.prototype.set=function(a){isNaN(a)||(this.value=a),this.bar.setAttribute("data-content",this.stats.HP+"/"+this.stats.maxHP);var b="bar-size-"+Math.max(Math.floor(this.stats.HP/this.stats.maxHP*100),0);this.bar.className.match(/size/)?this.bar.className=this.bar.className.replace(/bar-size-[0-9]{1,3}/,b):this.bar.classList.add(b)},a.prototype.setStyle=function(a){var b=this,c={hilight:"hilighted","default":"default"};a=c[a],a&&(Object.values(c).filter(function(b){return b!==a}).forEach(function(a){b.bar.classList.remove(a),b.label.classList.remove(a)}),this.bar.classList.add(a),this.label.classList.add(a))},a.prototype.remove=function(){this.bar.remove(),this.label.remove()},a.prototype.hide=function(){this.bar.style.display="none",this.label.style.display="none"},a.prototype.show=function(){this.bar.style.display="",this.label.style.display=""},a}(),MoveBlocking=function(a){return function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.apply(this,arguments))}return _inherits(b,a),_createClass(b,[{key:"isMoveBlocking",get:function(){return!0}}]),b}(a)},VisionBlocking=function(a){return function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.apply(this,arguments))}return _inherits(b,a),_createClass(b,[{key:"isVisionBlocking",get:function(){return!0}}]),b}(a)},Hittable=function(a){return function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.apply(this,arguments))}return _inherits(b,a),b.prototype.takeDamage=function(a,b){return this.stats.HP-=a,this.lifebar&&this.lifebar.set(this.stats.HP),0>=this.stats.HP?(this.die(b),!0):!1},b.prototype.heal=function(){if(this.stats.maxHP>this.stats.HP&&this.isAlive){var a=this.stats.INT/2+1|0;this.stats.HP+=a,this.stats.HP>this.stats.maxHP&&(this.stats.HP=this.stats.maxHP),this.lifebar&&this.lifebar.set(this.stats.HP)}},b.prototype.die=function(a){a&&a.log(this.flavorName+" died","death"),this.lifebar&&"Player"!==this.type&&this.lifebar.remove()},_createClass(b,[{key:"isHittable",get:function(){return!0}}]),b}(a)},Item=function(a){function Item(b){_classCallCheck(this,Item);var c=_possibleConstructorReturn(this,a.call(this,b));return c.canDrop=!0,c}return _inherits(Item,a),Item.prototype.update=function(){return!0},Item}(GameObject),Weapon=function(a){function Weapon(b,c,d){_classCallCheck(this,Weapon);var e=_possibleConstructorReturn(this,a.call(this,null));return e.slot="weapon",e.damage=c||1,e.speed=d||10,e.name=b,e.glyph="(",e.color="red",e.bgColor=TILE_COLOR,e.flavorName=e.name,e}return _inherits(Weapon,a),Weapon.prototype.toString=function(){return this.name+" ("+this.damage+", "+this.speed+")"},Weapon}(Item),Armor=function(a){function Armor(b,c,d){_classCallCheck(this,Armor);var e=_possibleConstructorReturn(this,a.call(this,null));return e.slot=b,e.name=c,e.defence=d,e.glyph="[",e.color="cyan",e.bgColor=TILE_COLOR,e.flavorName=e.name,e}return _inherits(Armor,a),Armor.prototype.toString=function(){return this.name+" ("+this.defence+")"},Armor}(Item),Creature=function(a){function Creature(b,c,d){_classCallCheck(this,Creature);var e=_possibleConstructorReturn(this,a.call(this,b));e.actions=[];var f=e;return e.stats=c||{maxHP:3,HP:3,viewDistance:5,moveSpeed:10,inventorySize:5,STR:1,INT:1,DEX:1,XP:0,XL:1,get AC(){return Object.keys(f.equipment).filter(function(a){return f.equipment[a]&&f.equipment[a].constructor===Armor}).reduce(function(a,b){return f.equipment[b].defence+a},0)}},e.inventory=[],e.equipment={weapon:d||Utils.defaults.weapon(),head:null,body:null,hands:null,legs:null,feet:null},e.flavorName="creature",e.flavor="It is mundane.",e.killcount=0,e}return _inherits(Creature,a),Creature.prototype.update=function(){var a=this,b=1>=arguments.length||void 0===arguments[1]?0:arguments[1],c=0,d=0;this.actions.forEach(function(e){try{var f=void 0;e.some(function(c){var d=c();return d.try(a,b)?(f=d,!0):!1}),d+=f.do(a),c++}catch(g){}});for(var e=0;c>e;e++)this.actions.shift();return d},Creature.prototype.gainXP=function(a){return this.stats.XP+=a,this.stats.XP>=BASE_XP*Math.pow(this.stats.XL+1,BASE_XP_GROWTH)?this.levelUp():!1},Creature.prototype.levelUp=function(){this.stats.XL++;var a=["maxHP","STR","INT","DEX"],b=a[Math.floor(Math.random()*a.length)];return this.stats[b]++,"maxHP"===b&&this.lifebar.set(),b},Creature.prototype.toString=function(){return this.type+"<br>"+this.stats.HP+" HP<br>"+this.flavor+"<br>"+this.equipment.weapon.damage+" ATT"},_createClass(Creature,[{key:"items",get:function(){var a=this.inventory.concat(Object.values(this.equipment)).filter(function(a){return a});return a}}]),Creature}(Hittable(MoveBlocking(GameObject))),DungeonFeature=function(a){function b(c){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.call(this,c))}return _inherits(b,a),b}(GameObject),Enemy=function(a){function Enemy(b,c,d){_classCallCheck(this,Enemy);var e=_possibleConstructorReturn(this,a.call(this,b,c,d));return e.actions=[],e.bgColor="hsl(30, 30%, 45%)",e.glyph="E",e.color="white",e.stats.maxHP=3,e.stats.HP=3,e.stats.viewDistance=7,e.stats.moveSpeed=9,e.stats.XP=1,e.stats=c||e.stats,e.flavorName="the enemy",e.flavor="It has a fearsome visage.",e}return _inherits(Enemy,a),Enemy.prototype.toString=function(){return this.type+"<br>Lvl. "+this.stats.XL+"<br>"+(this.noticed?"It has noticed you.":"It has not noticed you.")+"<br>"+this.flavor},Enemy.prototype.createLifebar=function(){this.lifebar=new Lifebar(this.id,this.type,document.getElementById("info-container-other-life"),this.stats)},Enemy}(Creature),Vector=function(){function a(b,c){_classCallCheck(this,a),this.u=isNaN(b)?Math.sign(10*Math.random()-5):b,this.v=isNaN(c)?Math.sign(10*Math.random()-5):c}return a.prototype.set=function(a){this.u=a[0],this.v=a[1]},a.prototype.reduce=function(){var a=this.get,b=Math.max.apply(null,a.map(Math.abs));this.set(a.map(function(a){return Math.round(a/b)}))},_createClass(a,[{key:"get",get:function(){return[this.u,this.v]}}]),a}(),KeyHandler=function(){function a(){_classCallCheck(this,a),this.use("default")}return a.prototype.use=function(){var a=0>=arguments.length||void 0===arguments[0]?"default":arguments[0];if("default"===a)this.using="default",this.keyCases={104:"n",100:"w",98:"s",102:"e",105:"ne",99:"se",97:"sw",103:"nw",75:"n",76:"e",74:"s",72:"w",89:"nw",85:"ne",66:"sw",78:"se",101:"c",71:"pickup",68:{use:"inventorydialog",act:"drop"},87:{use:"inventorydialog",act:"equip"},84:{use:"inventorydialog",act:"unequip"},60:"up",226:"up",83:"up",0:"cheat",Numpad1:"sw",Numpad2:"s",Numpad3:"se",Numpad4:"w",Numpad5:"c",Numpad6:"e",Numpad7:"nw",Numpad8:"n",Numpad9:"ne",KeyH:"w",KeyJ:"s",KeyK:"n",KeyL:"e",KeyY:"nw",KeyU:"ne",KeyB:"sw",KeyN:"se",KeyG:"pickup",KeyD:{use:"inventorydialog",act:"drop"},KeyW:{use:"inventorydialog",act:"equip"},KeyT:{use:"inventorydialog",act:"unequip"},KeyS:"up",Backquote:"cheat"},this.actionMap={n:function(){return new Vector(0,-1)},w:function(){return new Vector(-1,0)},s:function(){return new Vector(0,1)},e:function(){return new Vector(1,0)},ne:function(){return new Vector(1,-1)},se:function(){return new Vector(1,1)},sw:function(){return new Vector(-1,1)},nw:function(){return new Vector(-1,-1)},c:"rest",pickup:"pickup",up:"stair",down:"stair",cheat:"cheat"};else if("inventorydialog"===a){this.using="inventorydialog";var b="abcdefghijklmnopqrstuvwxyz".split("").reduce(function(a,b){return a[b.toUpperCase().charCodeAt(0)]=b,a},{}),c="abcdefghijklmnopqrstuvwxyz".split("").reduce(function(a,b){return a["Key"+b.toUpperCase()]=b,a},{});this.keyCases=Object.assign(b,c)}},a.prototype.get=function(a){if("object"===_typeof(this.keyCases[a]))return this.act=this.keyCases[a].act,this.use(this.keyCases[a].use),this.act;if("inventorydialog"===this.using){var b=this.keyCases[a];return this.use(),this.act+":"+b}return this.act=void 0,this.actionMap[this.keyCases[a]]},a}(),Utils=function(){function a(){_classCallCheck(this,a)}return a.rotate=function(b,c){return 90===c?a.transpose(b.reverse()):-90===c?a.transpose(b).reverse():180===c||-180===c?a.transpose(a.transpose(b).reverse()).reverse():b},a.transpose=function(a){var b=a.length?a.length:0,c=a[0]instanceof Array?a[0].length:0;if(0===c||0===b)return[];var d,e,f=[];for(d=0;c>d;d++)for(f[d]=[],e=0;b>e;e++)f[d][e]=a[e][d];return f},a.beamcast=function(a){for(var b=[],c=0;a.length>c;c++)b[c]=Array.from(Array(a.length));b[0][0]=a[0][0];for(var d=0;a[d]&&a[d][0]&&(b[d][0]=a[d][0],!a[d][0].top||!a[d][0].top.isVisionBlocking);)d++;for(var e=0;a[0]&&a[0][e]&&(b[0][e]=a[0][e],!a[0][e].top||!a[0][e].top.isVisionBlocking);)e++;for(var f=1,g=31;g>=f;f++)for(var h=f,i=0,j=g,k=0;j>=i;k++){var l=h>>5,m=k-l,n=g+1-(h&g),o=!1;if(n>i&&(a[m]&&a[m][l]?(b[m][l]=a[m][l],a[m][l].top&&a[m][l].top.isVisionBlocking&&(i=n,o=!0)):(i=n,o=!0)),n>j&&(a[m]&&a[m][l]?(b[m][l]=a[m][l],a[m][l].top&&a[m][l].top.isVisionBlocking&&(j=n,o=!0)):(j=n,o=!0)),h+=f,o)break}return b},a.mergeQuarters=function(a){var b=a.nw.map(function(b,c){return b.pop(),b.concat(a.ne[c])}),c=a.sw.map(function(b,c){return b.pop(),b.concat(a.se[c])});return b.pop(),b.concat(c)},a.saveGame=function(a){var b={};b.objs=a.objs,b.objs.forEach(function(a){return delete a.fov}),localStorage.setItem(saveName,LZString.compress(JSON.stringify(b)))},a.loadGame=function(){var a=JSON.parse(LZString.decompress(localStorage.getItem(saveName))||null);if(!a)return null;var b=function(){var b={Wall:Wall,Creature:Creature,Enemy:Enemy,Player:Player,Item:Item,Weapon:Weapon},c=[];return a.objs.forEach(function(a){a&&b[a.type]&&(c[a.id]=b[a.type].from(a))}),{v:c}}();return"object"===(void 0===b?"undefined":_typeof(b))?b.v:void 0},a.deleteSave=function(){localStorage.removeItem(saveName)},a.screenToGame=function(a,b,c){return new Point(Math.floor(a.x/(b+c)),Math.floor(a.y/(b+c)))},a.gameToScreen=function(a,b,c){return new Point(a.x*(b+c),a.y*(b+c))},a.screenToTiles=function(b,c,d){return a.gameToScreen(a.screenToGame(b,c,d),c,d)},a.exportObjs=function(a){for(var b in a)global[b]=a[b]},a.randomWeapon=function(a){var b=["Bronze","Iron","Steel"],c=["Dagger","Sword","Axe","Pikestaff"],d=b[Math.floor(Math.random()*b.length)]+" "+c[Math.floor(Math.random()*c.length)];return new Weapon(d,Math.floor(Math.random()*a*.8)+Math.floor(2*Math.random())+1,Math.floor(6*Math.random())+Math.max(10-a,2))},a.randomArmor=function(a){var b=["Bronze","Iron","Steel"],c={head:["cap","coif","helmet"],body:["chainmail","tunic","platebody"],hands:["gauntlets","gloves","mittens"],legs:["greaves","shin guards","tassets"],feet:["boots","shoes","sandals"]},d=Object.keys(c)[Math.floor(Math.random()*Object.keys(c).length)],e=b[Math.floor(Math.random()*b.length)]+" "+c[d][Math.floor(Math.random()*c[d].length)];return new Armor(d,e,Math.floor(Math.random()*a*.5)+1)},a.initUIButtons=function(a){var b=this;document.getElementById("button-save").addEventListener("click",function(c){c.stopPropagation(),b.saveGame(a)}),document.getElementById("button-delete").addEventListener("click",function(a){a.stopPropagation(),b.deleteSave()})},_createClass(a,null,[{key:"defaults",get:function(){return{weapon:function a(){var a=new Weapon("Fists");return a.canDrop=!1,a}}}},{key:"exports",get:function(){return{instance:game,Creature:Creature,Player:Player,GameObject:GameObject,Point:Point,Vector:Vector,ActionManager:ActionManager,TileGroup:TileGroup,Utils:a,Tile:Tile,Wall:Wall}}},{key:"alphabetMap",get:function(){return["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"]}},{key:"DamageCalculator",get:function(){return function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"constants",get:function(){return{baseAC:.1,defenderStrEffectiveness:10,attackerStrEffectiveness:2,attackerDexEffectiveness:1.7}}},{key:"physical",get:function(){var a=this;return{melee:function(b,c){var d=(c.stats.AC+a.constants.baseAC)*(1+c.stats.STR/a.constants.defenderStrEffectiveness),e=b.equipment.weapon.damage+(b.stats.STR/a.constants.attackerStrEffectiveness+b.stats.DEX/a.constants.attackerDexEffectiveness)/2;return Math.max(Math.floor(e-d),0)}}}}]),a}()}}]),a}(),MouseHandler=function(){function a(b){_classCallCheck(this,a),this.board=b;var c=document.createElement("div");c.id="cursor",c.style.width=this.board.tileSize+"px",c.style.height=this.board.tileSize+"px",this.cursor=c,document.body.appendChild(this.cursor)}return a.prototype.cursorFromScreen=function(a){var b=Utils.screenToTiles(a,this.board.tileSize,this.board.spacing).get,c=b[0],d=b[1];this.cursor.style.top=d+"px",this.cursor.style.left=c+"px"},a.prototype.cursorFromGame=function(a){var b=Utils.gameToScreen(a,this.board.tileSize,this.board.spacing).get,c=b[0],d=b[1];this.cursor.style.top=d+"px",this.cursor.style.left=c+"px"},a}(),EquipmentManager=function(){function a(b,c){_classCallCheck(this,a),this.wrapper=b,this.equipment=c;var d=document.createElement("div");d.style.padding="10px",this.container=d,this.wrapper.appendChild(this.container)}return a.prototype.update=function(){var a=this;this.container.children.length&&Array.from(this.container.children).forEach(function(a){return a.remove()}),Object.keys(this.equipment).filter(function(b){return a.equipment[b]}).forEach(function(b,c){var d=document.createElement("div"),e=document.createElement("div"),f=document.createElement("div"),g=document.createElement("div");d.className="equipment-row",e.className="equipment-key",f.className="equipment-slot",g.className="equipment-item",e.innerHTML=Utils.alphabetMap[c],f.innerHTML=b,g.innerHTML=a.equipment[b],d.appendChild(e),d.appendChild(f),d.appendChild(g),a.container.appendChild(d)})},a}(),InventoryManager=function(){function a(b,c){_classCallCheck(this,a),this.wrapper=b,this.inventory=c;var d=document.createElement("div");d.style.padding="10px",this.container=d,this.wrapper.appendChild(this.container)}return a.prototype.update=function(){var a=this;this.container.children.length&&Array.from(this.container.children).forEach(function(a){return a.remove()}),this.inventory.forEach(function(b,c){var d=document.createElement("div");d.innerHTML=Utils.alphabetMap[c]+" - "+b,a.container.appendChild(d)})},a}(),LogboxManager=function(){function a(b,c){_classCallCheck(this,a),this.logbox=b,this.rowCount=c,this.rows=[],this.messages=[];for(var d=0;this.rowCount>d;d++){var e=document.createElement("div");e.className="logbox-row",e.id="logbox-row-"+(d+1),this.logbox.appendChild(e),this.rows.push(e)}}return a.prototype.log=function(a){var b=this,c=1>=arguments.length||void 0===arguments[1]?"default":arguments[1];a=a.charAt(0).toUpperCase()+a.slice(1);var d=document.createElement("span");d.className="logmsg logmsg-"+c,d.innerHTML=a,this.messages.push(d);var e=this.rows.find(function(a){return 0===a.children.length});e?e.appendChild(d):(this.rows[0].children[0].remove(),this.rows.forEach(function(a,c){a.appendChild(b.messages[b.messages.length-(b.rowCount-c)])}))},a}(),StatsManager=function(){function a(b,c,d,e){_classCallCheck(this,a),this.playerWrap=b,this.gameCont=c,this.playerStats=d,this.gameStats=e,this.usedPlayerStats={STR:"STR",INT:"INT",DEX:"DEX",viewDistance:"Vision",moveSpeed:"Speed",AC:"AC",XL:"XL",XP:"XP"},this.usedGameStats={dungeonName:"",time:"Time",currentDungeonLevel:"Depth",score:"Score"},this.create()}return a.prototype.create=function(){var a=this,b=document.createElement("div");b.style.padding="10px",this.playerStatCont=b,this.playerStatElements={},Object.keys(this.usedPlayerStats).forEach(function(b){var c=document.createElement("div"),d=document.createElement("div"),e=document.createElement("div");c.className="player-stat-row",d.className="player-stat-name",e.className="player-stat-value",d.innerHTML=a.usedPlayerStats[b],e.innerHTML=a.playerStats[b],c.appendChild(d),c.appendChild(e),"XL"===b||"XP"===b?a.playerWrap.appendChild(c):a.playerStatCont.appendChild(c),a.playerStatElements[b]={stat:d,value:e}}),this.playerWrap.appendChild(this.playerStatCont),this.gameStatElements={},Object.keys(this.usedGameStats).forEach(function(b){var c=document.createElement("div"),d=document.createElement("div"),e=document.createElement("div");c.className="game-stat-row",d.className="game-stat-name",e.className="game-stat-value",c.id="game-stat-"+b,d.innerHTML=a.usedGameStats[b],e.innerHTML=a.gameStats[b],c.appendChild(d),c.appendChild(e),a.gameCont.appendChild(c),a.gameStatElements[b]={stat:d,value:e}})},a.prototype.update=function(){var a=this;Object.keys(this.usedPlayerStats).forEach(function(b){a.playerStatElements[b].value.innerHTML=a.playerStats[b]}),Object.keys(this.usedGameStats).forEach(function(b){a.gameStatElements[b].value.innerHTML=a.gameStats[b]})},a}(),Tile=function(){function a(b){_classCallCheck(this,a),this.position=b,this.contents=[]}return a.prototype.add=function(a){if(!a instanceof GameObject)throw new TypeError("Added object must be of type GameObject.");a.isMoveBlocking?this.contents.unshift(a):this.contents.push(a)},a.prototype.remove=function(a){var b=this.contents.indexOf(a);return b>-1?(this.contents.splice(b,1),!0):!1},a.prototype.empty=function(){this.contents=[]},a.prototype.toString=function(){return"Floor"},_createClass(a,[{key:"isEmpty",get:function(){return 0===this.contents.length}},{key:"top",get:function(){return this.contents[0]}},{key:"get",get:function(){return this.contents}}]),a}(),TileGroup=function(){function a(b,c){var d=this;_classCallCheck(this,a);for(var e in c)this[e]=c[e];if(b)this.matrix=b,this.w=this.matrix[0].length,this.h=this.matrix.length;else{this.matrix=[];for(var f=0;this.h>f;f++){this.matrix[f]=[];for(var g=0;this.w>g;g++)this.matrix[f][g]=new Tile(new Point(g,f))}}if(this.matrix.forEach(this.origin.x>=0?function(a,b){return d.matrix[b]=Array(d.origin.x).concat(d.matrix[b])}:function(a,b){for(var c=0;-d.origin.x>c;c++)d.matrix[b].shift()}),this.origin.y>=0)this.matrix=Array(this.origin.y).concat(this.matrix);else for(var h=0;-this.origin.y>h;h++)this.matrix.shift();this.baseColor=this.baseColor||"slategrey",this.tileSize=this.tileSize||25,this.spacing=this.spacing||1}return a.prototype.update=function(){var a=this;this.matrix.forEach(function(b){return b.forEach(function(b){if(b&&!b.isEmpty){var c=b.top;b.contents.shift(),a.insert(c)}})})},a.prototype.insert=function(a){var b=a.position.get,c=b[0],d=b[1];this.has(a.position)&&this.matrix[d][c].add(a)},a.prototype.remove=function(a){var b=a.position.get,c=b[0],d=b[1];this.has(a.position)&&this.matrix[d][c].remove(a)},a.prototype.clear=function(){this.matrix.forEach(function(a){return a.forEach(function(a){return a.empty()})})},a.prototype.has=function(a){var b=a.get,c=b[0],d=b[1];return!!this.matrix[d]&&!!this.matrix[d][c]},a.prototype.get=function(a){var b=a.get,c=b[0],d=b[1];return this.has(a)?this.matrix[d][c]:void 0},a.prototype.draw=function(){var a=this;this.matrix.forEach(function(b){return b.forEach(function(b){if(b){var c=b.position.get,d=c[0],e=c[1];b.isEmpty?(mainCtx.fillStyle=a.baseColor,mainCtx.fillRect(d*(a.tileSize+a.spacing),e*(a.tileSize+a.spacing),a.tileSize,a.tileSize)):(mainCtx.fillStyle=b.top.bgColor,mainCtx.fillRect(d*(a.tileSize+a.spacing),e*(a.tileSize+a.spacing),a.tileSize,a.tileSize),mainCtx.fillStyle=b.top.color,mainCtx.fillText(b.top.glyph,d*(a.tileSize+a.spacing)+a.tileSize/2,e*(a.tileSize+a.spacing)+a.tileSize/1.5))}})})},_createClass(a,[{key:"bounds",get:function(){return{x:this.origin.x*(this.tileSize+this.spacing),y:this.origin.y*(this.tileSize+this.spacing),w:this.w*(this.tileSize+this.spacing)-this.spacing,h:this.h*(this.tileSize+this.spacing)-this.spacing}}}]),a}(),Corpse=function(a){function Corpse(b){_classCallCheck(this,Corpse);var c=_possibleConstructorReturn(this,a.call(this,b));return c.bgColor="hsl(0,40%,40%)",c.glyph="x",c.color="hsl(0,40%,10%)",c.flavorName="corpse",c}return _inherits(Corpse,a),Corpse.prototype.update=function(){return 0},Corpse}(GameObject),AttackAction=function(a){function b(c,d,e){_classCallCheck(this,b);var f=_possibleConstructorReturn(this,a.call(this,c,d));return f.direction=e,f}return _inherits(b,a),b.prototype.try=function(a,b){if(a.equipment.weapon||(a.equipment.weapon=Utils.defaults.weapon()),this.duration=a.equipment.weapon.speed,b%this.duration!==0)return!1;var c=new(Function.prototype.bind.apply(Point,[null].concat(a.position.get)));c.moveBy(this.direction);var d=this.context.get(c);return d&&d.top&&d.top.isHittable&&a.isAlive},b.prototype.do=function(a){var b=new(Function.prototype.bind.apply(Point,[null].concat(a.position.get)));b.moveBy(this.direction),b=this.context.get(b);var c=Utils.DamageCalculator.physical.melee(a,b.top);this.logger&&this.logger.log(a.flavorName+" hit "+b.top.flavorName+" for "+c+" damage with "+a.equipment.weapon,a.constructor===Player?"hit":"damage");var d=b.top.takeDamage(c,this.logger);if(d){a.killcount++;var e=a.gainXP(b.top.stats.XP);e&&this.logger.log(a.flavorName+" leveled up and gained a point in "+e,"hilight"),b.top.items.forEach(function(a){a.canDrop&&(a.position=new(Function.prototype.bind.apply(Point,[null].concat(b.top.position.get))),b.add(a))}),b.add(new Corpse(new(Function.prototype.bind.apply(Point,[null].concat(b.top.position.get))))),b.remove(b.top)}return this.context.update(),this.duration},b}(Action),ItemDropAction=function(a){function b(c,d,e){_classCallCheck(this,b);var f=_possibleConstructorReturn(this,a.call(this,c,d));return f.inventorySlot=e,f}return _inherits(b,a),b.prototype.try=function(a,b){var c=!!a.inventory[Utils.alphabetMap.indexOf(this.inventorySlot)];return c||this.logger.log("No such item"),b%10===0&&c&&a.isAlive},b.prototype.do=function(a){var b=Utils.alphabetMap.indexOf(this.inventorySlot),c=a.inventory[b];return a.inventory.splice(b,1),c.position=new(Function.prototype.bind.apply(Point,[null].concat(a.position.get))),this.context.insert(c),this.logger.log(a.flavorName+" dropped "+c),10},b}(Action),ItemUnequipAction=function(a){function b(c,d,e){_classCallCheck(this,b);var f=_possibleConstructorReturn(this,a.call(this,c,d));return f.equipmentSlot=e,f}return _inherits(b,a),b.prototype.try=function(a,b){var c=Utils.alphabetMap.indexOf(this.equipmentSlot),d=Object.keys(a.equipment).filter(function(b){return null!==a.equipment[b]}).some(function(a,b){return b===c});return d?b%10===0&&d&&a.isAlive:(this.logger.log("No such item"),!1)},b.prototype.do=function(a){var b=Utils.alphabetMap.indexOf(this.equipmentSlot),c=Object.keys(a.equipment).filter(function(b){return null!==a.equipment[b]}).find(function(a,c){return c===b}),d=a.equipment[c];return d.canDrop&&a.inventory.push(d),a.equipment[c]=null,this.logger.log(a.flavorName+" unequipped "+d,"junk1"),10},b}(Action),ItemEquipAction=function(a){function b(c,d,e){_classCallCheck(this,b);var f=_possibleConstructorReturn(this,a.call(this,c,d));return f.inventorySlot=e,f}return _inherits(b,a),b.prototype.try=function(a,b){var c=!!a.inventory[Utils.alphabetMap.indexOf(this.inventorySlot)];return c?b%10===0&&c&&a.isAlive:(this.logger.log("No such item"),!1)},b.prototype.do=function(a){var b=Utils.alphabetMap.indexOf(this.inventorySlot),c=a.inventory[b],d=0;if(a.equipment[c.slot]){var e=Utils.alphabetMap[Object.keys(a.equipment).filter(function(b){return a.equipment[b]}).indexOf(c.slot)],f=new ItemUnequipAction(null,this.logger,e);d+=f.do(a)}return c=a.inventory.splice(b,1)[0],a.equipment[c.slot]=c,this.logger.log(a.flavorName+" equipped "+c,"junk1"),d+10},b}(Action),ItemPickupAction=function(a){function b(c,d){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.call(this,c,d))}return _inherits(b,a),b.prototype.try=function(a,b){return b%10===0&&a.stats.inventorySize>a.inventory.length&&this.context.get(a.position).contents.some(function(a){return a instanceof Item})&&a.isAlive},b.prototype.do=function(a){var b=this.context.get(a.position),c=b.contents.find(function(a){return a instanceof Item});return a.inventory.push(c),b.remove(c),this.logger&&this.logger.log(a.flavorName+" picked up "+c,"junk1"),10},b}(Action),MoveAction=function(a){function b(c,d,e){_classCallCheck(this,b);var f=_possibleConstructorReturn(this,a.call(this,c,d));return f.movement=e,f}return _inherits(b,a),b.prototype.try=function(a,b){if(this.duration=a.stats.moveSpeed,b%this.duration!==0)return!1;var c=new(Function.prototype.bind.apply(Point,[null].concat(a.position.get)));c.moveBy(this.movement);var d=this.context.get(c);return a.cheatMode||(d.isEmpty||d&&d.top&&!d.top.isMoveBlocking)&&a.isAlive},b.prototype.do=function(a){return a.position.moveBy(this.movement),this.context.update(),this.duration},b}(Action),NullAction=function(a){function b(c,d){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.call(this,c,d))}return _inherits(b,a),b.prototype.try=function(a,b){return b%10===0},b.prototype.do=function(){return 10},b}(Action),StairAction=function(a){function b(c,d){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.call(this,c,d))}return _inherits(b,a),b.prototype.try=function(a,b){var c=this.context.get(a.position),d=c&&c.contents.some(function(a){return a.constructor===Stair});return d||this.logger.log("No stairs here"),b%10===0&&d&&a.isAlive},b.prototype.do=function(a){var b=this.context.get(a.position).contents.find(function(a){return a.constructor===Stair});return a.dungeonLevelChange=b.direction,this.logger.log(a.flavorName+" went "+b.direction+" the stairs","junk2"),10},b}(Action),ActionManager=function(){function a(b,c){_classCallCheck(this,a),this.board=b,this.logger=c,this.proposalMap={},this.proposalMap[null]=[NullAction],this.proposalMap[Vector]=[MoveAction,AttackAction,NullAction],this.proposalMap.rest=[RestAction,NullAction],this.proposalMap.pickup=[ItemPickupAction,NullAction],this.proposalMap.drop=[ItemDropAction,NullAction],this.proposalMap.equip=[ItemEquipAction,NullAction],this.proposalMap.unequip=[ItemUnequipAction,NullAction],this.proposalMap.stair=[StairAction,NullAction]}return a.prototype.think=function(a,b){var c=this;if(a instanceof Enemy){var d=function(){var d=c.getFov(a),e=null,f=c.getFov(b).has(a.position);if(a.target=d.get(b.position),a.target&&b.isAlive){if(Point.equal(a.position,a.target.position))return a.target=void 0,{v:void 0};var g=Point.distance(a.position,a.target.position);g.reduce(),e=g,!a.noticed&&f&&c.logger.log(a.flavorName+" noticed "+b.flavorName,"threat1"),a.noticed=!0}else e=new Vector,a.noticed=!1;var h=c.proposalMap[e.constructor];if(h){var i=h.map(function(a){return function(){return new a(c.board,f?c.logger:null,e)}});a.actions.push(i)}}();if("object"===(void 0===d?"undefined":_typeof(d)))return d.v}},a.prototype.getFov=function(a){if(a){for(var b=a.position.get,c=b[0],d=b[1],e=a.stats.viewDistance,f={ne:[],se:[],sw:[],nw:[]},g=0;e>g;g++)for(var h=0;e>h;h++)f.ne[g]||(f.ne[g]=[],f.se[g]=[],f.sw[g]=[],f.nw[g]=[]),f.ne[g][h]=this.board.get(new Point(c+h,d-e+g+1)),f.se[g][h]=this.board.get(new Point(c+h,d+g)),f.sw[g][h]=this.board.get(new Point(c-e+h+1,d+g)),f.nw[g][h]=this.board.get(new Point(c-e+h+1,d-e+g+1));return f.ne=Utils.rotate(Utils.beamcast(Utils.rotate(f.ne,90)),-90),f.se=Utils.beamcast(f.se),f.sw=Utils.rotate(Utils.beamcast(Utils.rotate(f.sw,-90)),90),f.nw=Utils.rotate(Utils.beamcast(Utils.rotate(f.nw,180)),-180),new TileGroup(Utils.mergeQuarters(f),{origin:new Point(c-e+1,d-e+1),baseColor:TILE_COLOR,tileSize:25,spacing:1})}},a.prototype.delegateAction=function(a,b){var c=this;if(a){if(!a.isAlive){var d=this.proposalMap[null],e=d.map(function(a){return function(){return new a(c.board,c.logger,b)}});return a.actions.push(e),!0}if(b){var f=b;if("function"==typeof b)b=b(),f=b.constructor;else if("string"==typeof b){var g=b.split(":");if(f=g[0],b=g[1],!b)switch(f){case"drop":return this.logger.log("Which item to drop? [a-z]"),!1;case"equip":return this.logger.log("Which item to equip? [a-z]"),!1;case"unequip":return this.logger.log("Which item to unequip? [a-z]"),!1;case"cheat":return a.cheatMode=!a.cheatMode,this.logger.log("Cheat mode "+(a.cheatMode?"":"de")+"activated","hilight"),!1}}var h=this.proposalMap[f];if(h){var i=h.map(function(a){return function(){return new a(c.board,c.logger,b);
}});return a.actions.push(i),!0}}else if(null===b)return a.actions.push([function(){return new NullAction(null,c.logger)}]),!0;return!1}},a}(),Game=function(){function a(b,c){var d=this;_classCallCheck(this,a),this.logger=new LogboxManager(document.getElementById("logbox"),10);var e=this;this.stats={time:0,dungeonName:"Dungeon of Esc",currentDungeonLevel:0,get score(){return Math.round((e.player.killcount+1)*(e.stats.currentDungeonLevel+1)/(e.stats.time/1e4+1))}},this.dungeonLevels=[],this.board=b,this.player=c.objs[0],this.saveDungeonLevel(c),this.logic=new ActionManager(this.board,this.logger),this.keyHandler=new KeyHandler,document.addEventListener("keydown",function(a){d.logic.delegateAction(d.player,d.keyHandler.get(a.code||a.keyCode))&&d.update()});var f=document.getElementById("info-container-other-misc");this.examineContainer=document.createElement("div"),this.examineContainer.className="examine-container",f.appendChild(this.examineContainer),this.mouseHandler=new MouseHandler(this.board),document.addEventListener("mousemove",function(a){var b=d.board.bounds,c=new Point(a.pageX,a.pageY);if(c.in(b)){var e=d.player.fov,f=Utils.screenToGame(c,d.board.tileSize,d.board.spacing);if(d.mouseHandler.cursorFromScreen(c),e&&e.has(f)){var g=d.board.get(f);g&&g.top?(d.dungeonLevels[d.stats.currentDungeonLevel].objs.forEach(function(a){a.lifebar&&a.lifebar.setStyle("default")}),d.examineContainer.innerHTML=g.top,g.top instanceof Creature&&g.top.lifebar.setStyle("hilight")):d.examineContainer.innerHTML=g}else d.examineContainer.innerHTML="You can't see that"}else if(a.target.classList.contains("bar-lifebar")){d.dungeonLevels[d.stats.currentDungeonLevel].objs.forEach(function(a){a.lifebar&&a.lifebar.setStyle("default")});var h=a.target.id.match(/[0-9]+$/),i=d.dungeonLevels[d.stats.currentDungeonLevel].objs[+h];i&&(d.mouseHandler.cursorFromGame(i.position),d.examineContainer.innerHTML=i,i.lifebar.setStyle("hilight"))}}),this.inventoryManager=new InventoryManager(document.getElementById("info-container-inventory"),this.player.inventory),this.equipmentManager=new EquipmentManager(document.getElementById("info-container-equipment"),this.player.equipment),this.statsManager=new StatsManager(document.getElementById("info-container-player"),document.getElementById("info-container-game"),this.player.stats,this.stats)}return a.prototype.saveDungeonLevel=function(a){var b=this,c=a.rooms,d=a.paths,e=a.objs,f=a.stairs,g=new Image;g.src=secondCanvas.toDataURL(),this.dungeonLevels[this.stats.currentDungeonLevel]={objs:[],rooms:c,paths:d,stairs:f,map:g},e.forEach(function(a){return b.dungeonLevels[b.stats.currentDungeonLevel].objs[a.id]=a})},a.prototype.changeDungeonLevel=function(a){var b=this;this.saveDungeonLevel(this.dungeonLevels[this.stats.currentDungeonLevel]);var c=a>this.stats.currentDungeonLevel?"down":"up";this.dungeonLevels[this.stats.currentDungeonLevel].objs.forEach(function(a,b){0!==b&&a.lifebar&&a.lifebar.remove()}),this.stats.currentDungeonLevel=a,mainCtx.clearRect(0,0,w,h),secondCtx.clearRect(0,0,w,h),this.board.clear();var d=[];if(d[0]=this.player,this.dungeonLevels[a])if(d=this.dungeonLevels[a].objs,secondCtx.drawImage(this.dungeonLevels[a].map,0,0),"up"===c){var e;(e=this.player.position).set.apply(e,this.dungeonLevels[a].stairs.down.get)}else{var f;(f=this.player.position).set.apply(f,this.dungeonLevels[a].stairs.up.get)}else{var g=DungeonGenerator.types[Math.floor(Math.random()*DungeonGenerator.types.length)],i=DungeonGenerator[g].defaultOptions;i.stairs.up=!0,i.difficulty=this.stats.currentDungeonLevel;var j=DungeonGenerator[g].makeLevel(this.player,i);d=j.objs,this.dungeonLevels[a]={objs:[],rooms:j.rooms,paths:j.paths,stairs:j.stairs}}d.forEach(function(c){return b.dungeonLevels[a].objs[c.id]=c}),this.dungeonLevels[a].objs.forEach(function(a){a&&b.board.insert(a)}),this.dungeonLevels[a].objs.forEach(function(a){a&&b.logic.think(a,b.player)})},a.prototype.update=function(){var a=this,b=this.player.update(this.logger),c=b/TICK;if(this.player.dungeonLevelChange){var d=this.stats.currentDungeonLevel;"up"===this.player.dungeonLevelChange?d--:"down"===this.player.dungeonLevelChange&&d++,this.changeDungeonLevel(d),delete this.player.dungeonLevelChange}else this.player.isAlive||this.board.remove(this.player);for(var e=[],f=0;c>f;f++)this.stats.time+=TICK,this.dungeonLevels[this.stats.currentDungeonLevel].objs.forEach(function(b){if("Player"!==b.type)if(b.isAlive){var c=b.update(a.logger,a.stats.time+(e[b.id]||0));c>0&&(a.logic.think(b,a.player),e[b.id]=e[b.id]?e[b.id]+c:c),b.isAlive||(a.board.remove(b),delete a.dungeonLevels[a.stats.currentDungeonLevel].objs[b.id])}else a.board.remove(b),delete a.dungeonLevels[a.stats.currentDungeonLevel].objs[b.id]});var g=this.logic.getFov(this.player);this.player.fov=g,g&&(this.dungeonLevels[this.stats.currentDungeonLevel].objs.forEach(function(a){a instanceof Enemy&&(g.has(a.position)?a.lifebar.show():a.lifebar.hide())}),mainCtx.clearRect(0,0,w,h),this.player.cheatMode?this.board.draw():g.draw(),secondCtx.drawImage(mainCanvas,0,0)),this.inventoryManager.update(),this.equipmentManager.update(),this.statsManager.update()},a.prototype.start=function(){var a=this;this.logger.log("Hello and welcome","hilight"),this.dungeonLevels[this.stats.currentDungeonLevel].objs.forEach(function(b){b&&a.board.insert(b)});var b=this.logic.getFov(this.player);this.player.fov=b,this.dungeonLevels[this.stats.currentDungeonLevel].objs.forEach(function(c){a.logic.think(c,a.player),c instanceof Enemy&&(b.has(c.position)?c.lifebar.show():c.lifebar.hide())}),b.draw(),this.inventoryManager.update(),this.equipmentManager.update(),document.getElementById("loader").remove()},a}(),Rect=function(){function a(b){_classCallCheck(this,a),Object.assign(this,b),this.type||(this.type=a.type.DEFAULT)}return a.prototype.shrink=function(a){a!==~~a?(this.x+=Math.floor(a),this.y+=Math.floor(a),this.w-=Math.ceil(a),this.h-=Math.ceil(a)):(this.x+=a,this.y+=a,this.w-=2*a,this.h-=2*a)},a.prototype.grow=function(a){a!==~~a?(this.x-=Math.floor(a),this.y-=Math.floor(a),this.w+=Math.ceil(a),this.h+=Math.ceil(a)):(this.x-=a,this.y-=a,this.w+=2*a,this.h+=2*a)},a.prototype.clone=function(){return new a({x:this.x,y:this.y,w:this.w,h:this.h,type:this.type})},a.prototype.intersect=function(a){var b=this.x,c=this.x+this.w,d=this.y,e=this.y+this.h,f=a.x,g=a.x+a.w,h=a.y,i=a.y+a.h,j={left:1/0,right:1/0,bottom:1/0,top:1/0};c>=f&&f>=b&&(j.left=c-f),g>=b&&c>=g&&(j.right=g-b),i>=d&&e>=i&&(j.top=d-i),e>=h&&h>=d&&(j.bottom=h-e);var k=Object.keys(j).map(function(a){return j[a]}).reduce(function(a,b){return a>b?b:a});return k===1/0?!1:Object.keys(j).find(function(a){return j[a]===k})},_createClass(a,[{key:"mids",get:function(){return{top:new a({x:~~(this.x+this.w/2),y:this.y,w:1,h:1}),left:new a({x:this.x,y:~~(this.y+this.h/2),w:1,h:1}),right:new a({x:this.x+this.w,y:~~(this.y+this.h/2),w:1,h:1}),bottom:new a({x:~~(this.x+this.w/2),y:this.y+this.h,w:1,h:1})}}},{key:"split",get:function(){var b=this;return{h:function(c){return c=c||~~(Math.random()*b.h),[new a({x:b.x,y:b.y,w:b.w,h:c,splitDir:"h"}),new a({x:b.x,y:b.y+c,w:b.w,h:b.h-c,splitDir:"h"})]},w:function(c){return c=c||~~(Math.random()*b.w),[new a({x:b.x,y:b.y,w:c,h:b.h,splitDir:"w"}),new a({x:b.x+c,y:b.y,w:b.w-c,h:b.h,splitDir:"w"})]}}}}],[{key:"type",get:function(){return{DEFAULT:0,ROOM:1,PATH:2,CHUNK:3,DOOR:4}}}]),a}(),RestAction=function(a){function b(c,d){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.call(this,c,d))}return _inherits(b,a),b.prototype.try=function(a,b){return b%10===0},b.prototype.do=function(a){return a.isHittable&&a.heal(1),10},b}(Action),Stair=function(a){function Stair(b,c){_classCallCheck(this,Stair);var d=_possibleConstructorReturn(this,a.call(this,b));return d.direction=c,d.bgColor="hsl(0,0%,35%)","up"===d.direction?d.glyph="<":"down"===d.direction&&(d.glyph=">"),d.color="hsl(0,0%,75%)",d.flavorName=d.direction+"stair",d}return _inherits(Stair,a),Stair.prototype.update=function(){return 0},Stair.prototype.toString=function(){return"A staircase going "+this.direction},Stair}(GameObject),Wall=function(a){function Wall(b){_classCallCheck(this,Wall);var c=_possibleConstructorReturn(this,a.call(this,b));return c.bgColor="hsl(0,0%,15%)",c.glyph="â–‰",c.color="hsl(0,0%,25%)",c.flavorName="wall",c}return _inherits(Wall,a),Wall.prototype.update=function(){return 0},Wall}(VisionBlocking(MoveBlocking(DungeonFeature))),Honeybadger=function(a){function Honeybadger(b){_classCallCheck(this,Honeybadger);var c=_possibleConstructorReturn(this,a.call(this,b,null,new Weapon("Claws",4,11)));return c.bgColor="hsl(25, 5%, 10%)",c.glyph="B",c.color="hsl(5, 5%, 90%)",c.equipment.weapon.canDrop=!1,c.stats.maxHP=10,c.stats.HP=10,c.stats.viewDistance=7,c.stats.moveSpeed=10,c.flavorName="the honeybadger",c.flavor="Notorious for their ferocity.",c.createLifebar(),c}return _inherits(Honeybadger,a),Honeybadger}(Enemy),Jackalope=function(a){function Jackalope(b){_classCallCheck(this,Jackalope);var c=_possibleConstructorReturn(this,a.call(this,b,null,new Weapon("Antlers",2,5)));return c.bgColor="hsl(35, 25%, 65%)",c.glyph="J",c.color="hsl(35, 35%, 5%)",c.equipment.weapon.canDrop=!1,c.stats.maxHP=6,c.stats.HP=6,c.stats.viewDistance=7,c.stats.moveSpeed=8,c.flavorName="the jackalope",c.flavor="A large agressive rabbit with antlers on its head.",c.createLifebar(),c}return _inherits(Jackalope,a),Jackalope}(Enemy),Redcap=function(a){function Redcap(b){_classCallCheck(this,Redcap);var c=_possibleConstructorReturn(this,a.call(this,b,null,null));return c.bgColor="hsl(66, 10%, 70%)",c.glyph="^",c.color="hsl(0, 80%, 60%)",c.stats.maxHP=10,c.stats.HP=10,c.stats.viewDistance=7,c.stats.moveSpeed=10,c.flavorName="the redcap",c.flavor="A malevolent murderous dwarf-like creature.",c.createLifebar(),c.canWield=!0,c.canWear=!0,c}return _inherits(Redcap,a),Redcap}(Enemy),DungeonGenerator=function(){function a(){_classCallCheck(this,a)}return a.generateEquipment=function(a,b){if(a.canWield&&b.difficulty/5>Math.random()&&(a.equipment.weapon=Utils.randomWeapon(b.difficulty)),a.canWear&&b.difficulty/10>Math.random()){var c=Utils.randomArmor(b.difficulty);a.equipment[c.slot]=c}return a},a.generateEnemies=function(a,b){for(var c=[Jackalope,Honeybadger,Redcap],d=[],e=a.x+a.w;e>a.x;e--)for(var f=a.y+a.h;f>a.y;f--)if(Math.random()<b.enemies.spawnChance){var g=c[Math.floor(Math.random()*c.length)];g=new g(new Point(e,f)),g=this.generateEquipment(g,b);for(var h=1;b.difficulty>h;h++)g.levelUp(),g.stats.XP++;d.push(g)}return d},a.generateLoot=function(a,b){for(var c=[Utils.randomWeapon,Utils.randomArmor],d=[],e=a.x+a.w;e>a.x;e--)for(var f=a.y+a.h;f>a.y;f--)if(Math.random()<b.items.spawnChance){var g=c[Math.floor(Math.random()*c.length)],h=g(b.difficulty+1);h.position=new Point(e,f),d.push(h)}return d},_createClass(a,null,[{key:"types",get:function(){return["traditional","city","cave"]}},{key:"traditional",get:function(){return function(){function b(){_classCallCheck(this,b)}return b.makeRoom=function(a){var b={};return b.w=~~(Math.random()*(a.rooms.size.max.w-a.rooms.size.min.w)+a.rooms.size.min.w),b.h=~~(Math.random()*(a.rooms.size.max.h-a.rooms.size.min.h)+a.rooms.size.min.h),b.x=~~(Math.random()*(a.size.w-b.w)),b.y=~~(Math.random()*(a.size.h-b.h)),b},b.makePoint=function(a){return{x:~~(Math.random()*a.size.w),y:~~(Math.random()*a.size.h)}},b.makePaths=function(a,b,c){for(var d=[],e=0;c.paths.count>e;e++){var f={},g=b[e%c.paths.count%c.midPoints.count];f.x1=a[e].x+~~(Math.random()*a[e].w),f.y1=a[e].y+~~(Math.random()*a[e].h),f.x2=g.x,f.y2=a[e].y+~~(Math.random()*a[e].h),f.x3=g.x,f.y3=g.y,d.push(f)}for(var h=1;c.midPoints.count>h;h++){var i={};i.x1=b[h-1].x,i.y1=b[h-1].y,i.x2=b[h].x,i.y2=b[h-1].y,i.x3=b[h].x,i.y3=b[h].y,d.push(i)}return d},b.makeLevel=function(b,c){c=c||this.defaultOptions;var d=[],e=[],f=Array(c.rooms.count).fill(),g=Array(c.midPoints.count).fill();for(var h in f)f[h]=this.makeRoom(c);b.position.set(f[0].x+1,f[0].y+1),e.push(b);var i={};if(c.stairs.up){var j=new Point(f[0].x+1,f[0].y+1);e.push(new Stair(j,"up")),i.up=j}if(c.stairs.down){var k=new Point(f[c.rooms.count-1].x+1,f[c.rooms.count-1].y+1);e.push(new Stair(k,"down")),i.down=k}for(var l in g)g[l]=this.makePoint(c);for(var m=this.makePaths(f,g,c),n=0;c.size.h>n;n++){d[n]=[];for(var o=0;c.size.w>o;o++){var p=new Tile(new Point(o,n));p.add(new Wall(new Point(o,n))),d[n][o]=p}}f.forEach(function(b){for(var f=b.x+b.w;f>b.x;f--)for(var g=b.y+b.h;g>b.y;g--)d[g][f].empty();e=e.concat(a.generateEnemies(b,c)),e=e.concat(a.generateLoot(b,c))}),m.forEach(function(a){for(var b=Math.min(a.x1,a.x2),c=Math.max(a.x1,a.x2);c+1>b;b++)d[a.y1][b].empty();for(var e=Math.min(a.y2,a.y3),f=Math.max(a.y2,a.y3);f+1>e;e++)d[e][a.x2].empty()});for(var q=0;c.size.h>q;q++)for(var r=0;c.size.w>r;r++)d[q][r].isEmpty||e.push(d[q][r].top);return{rooms:f,paths:m,objs:e,stairs:i}},_createClass(b,null,[{key:"defaultOptions",get:function(){return{difficulty:1,stairs:{up:!1,down:!0},size:{w:40,h:20},rooms:{count:8,size:{max:{w:8,h:8},min:{w:3,h:3}}},midPoints:{count:2},paths:{count:8},enemies:{spawnChance:.02},items:{spawnChance:.001}}}}]),b}()}},{key:"city",get:function(){return function(){function b(){_classCallCheck(this,b)}return b.splitWithPath=function(a,b,c){if(c.chunks.size.min.w>a.w||c.chunks.size.min.h>a.h)return{path:null,chunks:[]};var d=(Math.floor(Math.random()*(a[b]-c.chunks.size.min[b]-c.paths.size-2*c.chunks.margin)+c.chunks.margin),a.split[b]()),e=d[1].split[b](c.paths.size);return d[0].type=Rect.type.CHUNK,e[0].type=Rect.type.PATH,e[1].type=Rect.type.CHUNK,{path:e[0],chunks:[d[0],e[1]]}},b.findLargestRect=function(a){if(1>=a.length){var b=a[0].chunks.reduce(function(a,b){return a.w*a.h>b.w*b.h?a:b}),c=a[0].chunks.reduce(function(a,b){return a.w*a.h>b.w*b.h?a:b}),d=b.w*b.h>c.w*c.h?b:c;return{rect:d,splitIndex:0,chunkIndex:a[0].chunks.indexOf(d)}}var e=a.reduce(function(a,b){if(0===b.chunks.length||0===a.chunks.length)return a;var c=b.chunks.reduce(function(a,b){return a.w*a.h>b.w*b.h?a:b}),d=a.chunks.reduce(function(a,b){return a.w*a.h>b.w*b.h?a:b});return c.w*c.h>d.w*d.h?b:a},a[0]);if(0===e.chunks.length)return{rect:null,splitIndex:null,chunkIndex:null};var f=e.chunks.reduce(function(a,b){return a.w*a.h>b.w*b.h?a:b}),g=a.indexOf(e),h=a[g].chunks.indexOf(f);return{rect:f,splitIndex:g,chunkIndex:h}},b.splitBase=function(a,b){var c=[];c.push(this.splitWithPath(a,"w",b));for(var d=0;b.main.splitCount>d;d++){var e=this.findLargestRect(c);if(!e.rect)break;var f="h"===e.rect.splitDir?"w":"h",g=this.splitWithPath(e.rect,f,b);c[e.splitIndex].chunks.splice(e.chunkIndex,1),c.push(g)}return c},b.splitChunks=function(a,b){var c=this,d=[].concat.apply([],a.map(function(a,b){return a.chunks.forEach(function(a){return a.splitIndex=b}),a.chunks}));return d.forEach(function(a){if(!(b.rooms.size.min.w>a.w||b.rooms.size.min.h>a.h)){a.rooms=[],a.rooms.push({chunks:a.split.w()});for(var d=0;b.chunks.splitCount>d;d++){var e=c.findLargestRect(a.rooms);if(!e.rect||b.rooms.size.min.w>e.rect.w||b.rooms.size.min.h>e.rect.h)break;var f="h"===e.rect.splitDir?"w":"h",g={chunks:e.rect.split[f]()};g.chunks.forEach(function(a){return a.type=Rect.type.ROOM}),a.rooms[e.splitIndex].chunks.splice(e.chunkIndex,1),a.rooms.push(g)}}}),a.map(function(a,b){return a.chunks=d.filter(function(a){return a.splitIndex===b}),a.chunks.forEach(function(a){}),a})},b.carveDoors=function(a,b){return a.forEach(function(a){a.doors=[],a.chunks.forEach(function(c){c.rooms&&c.rooms.forEach(function(c){c.chunks.forEach(function(d){var e=d.intersect(a.path);if(e){var f=d.mids[e];f.type=Rect.type.DOOR,"top"===e||"bottom"===e?(f.h+=b.doors.stretch,f.y-=b.doors.stretch/2|0):(f.w+=b.doors.stretch,f.x-=b.doors.stretch/2|0),f.x--,a.doors.push(f)}var g=d.intersect(c.chunks[Math.floor(Math.random()*c.chunks.length)]);if(g){var h=d.mids[g];h.type=Rect.type.DOOR,"top"===g||"bottom"===g?(h.h+=b.doors.stretch,h.y-=b.doors.stretch/2|0):(h.w+=b.doors.stretch,h.x-=b.doors.stretch/2|0),h.y--,h.x--,a.doors.push(h)}})})})}),a},b.makeLevel=function(b,c){var d=this;c=c||this.defaultOptions;var e=new Rect({x:0,y:0,w:c.main.size.w,h:c.main.size.h,type:Rect.type.CHUNK});try{var f=function(){for(var f=d.carveDoors(d.splitChunks(d.splitBase(e,c),c),c),g=[],h=[],i=[],j=[],k=0;c.main.size.h>k;k++){i[k]=[];for(var l=0;c.main.size.w>l;l++){var m=new Tile(new Point(l,k));i[k][l]=m}}f.forEach(function(a){a.path&&a.chunks.forEach(function(a){for(var b=a.x+a.w;b>a.x;b--)for(var c=a.y+a.h;c>a.y;c--)i[c-1][b-1].add(new Wall(new Point(b,c)))})}),f.forEach(function(a){a.path&&(h.push(a.path),a.chunks.forEach(function(a){a.rooms&&a.rooms.forEach(function(a){a.chunks.forEach(function(a){if(a.type===Rect.type.ROOM){a.shrink(1),g.push(a);for(var b=a.x+a.w;b>a.x;b--)for(var c=a.y+a.h;c>a.y;c--)i[c-1][b-1].empty()}})})}),a.doors&&a.doors.forEach(function(a){for(var b=a.x+a.w;b>a.x;b--)for(var c=a.y+a.h;c>a.y;c--)i[c]&&i[c][b]&&i[c][b].empty()}))});var n={};if(b.position.set(g[0].x+1,g[0].y+2),j.push(b),i[b.position.y][b.position.x].empty(),c.stairs.up){var o=new(Function.prototype.bind.apply(Point,[null].concat(b.position.get)));j.push(new Stair(o,"up")),n.up=o}if(c.stairs.down){var p=g.reduce(function(a,b){return a.w*a.h>b.w*b.h?a:b}),q=new Point(p.x+p.w-1,p.y+p.h-1);j.push(new Stair(q,"down")),n.down=q}g.forEach(function(b){j=j.concat(a.generateEnemies(b,c)),j=j.concat(a.generateLoot(b,c))});for(var r=0;c.main.size.h>r;r++)for(var s=0;c.main.size.w>s;s++)i[r][s].isEmpty||j.push(i[r][s].top);return{v:{rooms:g,paths:h,objs:j,stairs:n}}}();if("object"===(void 0===f?"undefined":_typeof(f)))return f.v}catch(g){throw g}},_createClass(b,null,[{key:"defaultOptions",get:function(){return{main:{size:{w:40,h:20},splitCount:6},difficulty:1,stairs:{up:!1,down:!0},paths:{size:2},chunks:{size:{min:{w:5,h:5}},margin:5,splitCount:2},rooms:{size:{min:{w:4,h:4},max:{w:10,h:10}}},doors:{stretch:3},enemies:{spawnChance:.02},items:{spawnChance:.009}}}}]),b}()}},{key:"cave",get:function(){return function(){function b(){_classCallCheck(this,b)}return b.border=function(a){for(var b=0;a[0].length>b;b++)a[0][b].empty(),a[0][b].add(new Wall(new Point(b,0))),a[a.length-1][b].empty(),a[a.length-1][b].add(new Wall(new Point(b,a.length-1)));for(var c=0;a.length>c;c++)a[c][0].empty(),a[c][0].add(new Wall(new Point(0,c))),a[c][a[0].length-1].empty(),a[c][a[0].length-1].add(new Wall(new Point(a[0].length-1,c)));return a},b.neighbors=function c(a,b,d,e){for(var c=[],f=b-e;b+e>=f;f++)for(var g=d-e;d+e>=g;g++)f===b&&g===d||!a[g]||c.push(a[g][f]);return c.filter(function(a){return a})},b.updateState=function(a,b,c,d){var e=this.neighbors(a,b,c,1),f=a[c][b].top?"wall":"floor";if(e.filter(function(a){return a.top&&a.top.constructor===Wall}).length>=d.nearCap)return{type:Wall,changed:"wall"!==f,pos:new Point(b,c)};var g=this.neighbors(a,b,c,2);return g.filter(function(a){return a.top&&a.top.constructor===Wall}).length<=d.farCap?{type:Wall,changed:"wall"!==f,pos:new Point(b,c)}:{type:null,changed:"floor"!==f,pos:new Point(b,c)}},b.makeLevel=function(b,c){var d=this;c=c||this.defaultOptions;for(var e=[],f=[],g=0;c.size.h>g;g++){e[g]=[];for(var h=0;c.size.w>h;h++)e[g][h]=new Tile(new Point(h,g)),Math.random()<c.distribution||e[g][h].add(new Wall(new Point(h,g)))}if(c.horizontalBlank)for(var i=~~(c.size.h/2),j=~~(c.size.h/2)-i+c.horizontalBlank,k=~~(c.size.h/2)-i;j>k;k++)e[k].forEach(function(a){return a.empty()});for(var l=function(a){var b=[];e.forEach(function(a,f){return a.forEach(function(a,g){b.push(d.updateState(e,g,f,c))})}),b.forEach(function(a){a.changed&&(a.type?e[a.pos.y][a.pos.x].add(new a.type(a.pos)):e[a.pos.y][a.pos.x].empty())}),c.border&&(e=d.border(e)),a>c.smoothCap&&(c.farCap=-1)},m=0;c.iterationCount>m;m++)l(m);var n={};if(c.stairs.up){for(var o,p=new Point(Math.floor(Math.random()*c.size.w),Math.floor(Math.random()*c.size.h));;){if(e[p.y]&&e[p.y][p.x]&&e[p.y][p.x].isEmpty)break;p.set(Math.floor(Math.random()*c.size.w),Math.floor(Math.random()*c.size.h))}(o=b.position).set.apply(o,p.get),f.push(b),f.push(new Stair(p,"up")),n.up=p}if(c.stairs.down){for(var q=new Point(Math.floor(Math.random()*c.size.w,Math.floor(Math.random()*c.size.h)));;){if(e[q.y]&&e[q.y][q.x]&&e[q.y][q.x].isEmpty)break;q.set(Math.floor(Math.random()*c.size.w),Math.floor(Math.random()*c.size.h))}f.push(new Stair(q,"down")),n.down=q}var r=a.generateEnemies({x:0,y:0,w:c.size.w-1,h:c.size.h-1},c).filter(function(a){return e[a.position.y][a.position.x].isEmpty?!0:(a.lifebar.remove(),!1)});f=f.concat(r);var s=a.generateLoot({x:0,y:0,w:c.size.w-1,h:c.size.h-1},c).filter(function(a){return e[a.position.y][a.position.x].isEmpty});f=f.concat(s);for(var t=0;c.size.h>t;t++)for(var u=0;c.size.w>u;u++)e[t][u].isEmpty||f.push(e[t][u].top);return{objs:f,paths:[],rooms:[],stairs:n}},_createClass(b,null,[{key:"defaultOptions",get:function(){return{size:{w:40,h:20},stairs:{up:!1,down:!0},iterationCount:7,distribution:.46,border:!0,nearCap:5,farCap:1,smoothCap:5,horizontalBlank:1,enemies:{spawnChance:.015},items:{spawnChance:.05}}}}]),b}()}}]),a}(),Player=function(a){function Player(b,c){_classCallCheck(this,Player);var d=_possibleConstructorReturn(this,a.call(this,b,c));return d.actions=[],d.bgColor="white",d.glyph="@",d.color="black",d.stats.maxHP=50,d.stats.HP=50,d.stats.viewDistance=8,d.stats.moveSpeed=10,d.stats=c||d.stats,d.equipment.head=new Armor("head","Bronze helmet",1),d.equipment.weapon=new Weapon("Blunt Dagger",1,5),d.lifebar=new Lifebar(d.id,"Hero",document.getElementById("info-container-player"),d.stats),d.flavorName="you",d.flavor="Hi mom!",d}return _inherits(Player,a),Player}(Creature),game=new Game(new TileGroup(null,{origin:new Point(0,0),baseColor:"slategrey",tileSize:25,spacing:1,w:40,h:20}),Utils.loadGame()||DungeonGenerator.traditional.makeLevel(new Player(new Point(10,10))));if("dev"===env)Utils.exportObjs(Utils.exports);else if("prod"!==env)throw new TypeError("Invalid environment");game.start(),function(){function a(a){if(a.target.classList.contains("moveable-anchor")){a.stopPropagation(),a.preventDefault();var b=a.pageX,c=a.pageY;void 0===b&&(b=a.touches[0].pageX,c=a.touches[0].pageY),i=b-elem.offsetLeft,j=c-elem.offsetTop,h="body",f=elem}}function b(a){a.stopPropagation(),a.preventDefault(),h="right",f=elem}function c(a){a.stopPropagation(),a.preventDefault(),h="bottom",f=elem}function d(a){if(h&&f){var b=a.pageX,c=a.pageY;void 0===b&&(b=a.touches[0].pageX,c=a.touches[0].pageY),"right"===h?f.style.width=f.offsetWidth+(b-f.offsetWidth)-f.offsetParent.offsetLeft-f.offsetLeft+"px":"bottom"===h?f.style.height=f.offsetHeight+(c-f.offsetHeight)-f.offsetParent.offsetTop-f.offsetTop+"px":"body"===h&&(f.style.top=c-j+"px",f.style.left=b-i+"px")}}function e(a){a.stopPropagation(),h=!1,f=void 0}var f,g=Array.from(document.querySelectorAll(".moveable, .resizeable")),h=!1,i=0,j=0;g.forEach(function(d){var e=document.createElement("div"),f=document.createElement("div");e.classList.add("edge"),f.classList.add("edge"),e.classList.add("edge-right"),f.classList.add("edge-bottom"),d.classList.contains("moveable")&&(d.addEventListener("mousedown",a),d.addEventListener("touchstart",a)),d.classList.contains("resizeable")&&(f.addEventListener("mousedown",c),f.addEventListener("touchstart",c),e.addEventListener("mousedown",b),e.addEventListener("touchstart",b),d.appendChild(e),d.appendChild(f))}),document.addEventListener("mousemove",d),document.addEventListener("touchmove",d),document.addEventListener("mouseup",e),document.addEventListener("touchend",e)}()}(window);
//# sourceMappingURL=eschack.min.js.map